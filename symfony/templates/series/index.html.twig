{% extends 'base.html.twig' %}

{% block title %}Series
{% endblock %}

{% block body %}
	<div class="flex items-center w-screen flex-col py-8 ">
		<div class="container flex items-center px-8 w-full flex-col ">
			<h1 class="text-4xl text-center text-white font-bold mb-12">Series</h1>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-8">
                {% for series in pagination.items %}
                    {% if user %}
                        {% set nb_episodes = 0 %}
                        {% set nb_episodes_seen = 0 %}
                        {% set user_episodes = user.episode|map(e => e.id)|join(',') %}
                        {% set series_episodes = series.seasons|map(s => s.episodes|map(e => e.id)|join(','))|join(',') %}
                        {% set nb_episodes_seen = series_episodes|split(',')|filter(e => e in user_episodes|split(','))|length %}
                        {% set nb_episodes = series.seasons|map(s => s.episodes|length)|reduce((a, b) => a + b) %}
                    {% endif %}
                    <div class="flex justify-between flex-col w-full transform transition-transform duration-300 hover:scale-105 bg-gray-900 rounded-lg hover:border-red-500 border-2 border-transparent h-full">
                        <a href="{{ path('app_series_show', {'id': series.id}) }}">
                            <img src="{{ path('app_series_poster', {'id': series.id }) }}" alt="{{ series.title }}" class="w-full h-fit object-cover rounded-t-lg">
                            <div class="p-4">
                                    <h2 class="text-white text-xl font-bold mb-2">{{ series.title }}</h2>
                                    <p class="text-white mb-2">Seasons: {{ series.seasons|length }}</p>
                                    <p class="text-white mb-2">Year: {{ series.yearStart }} - {% if series.yearEnd is null %}present{% else %}{{ series.yearEnd }}{% endif %}</p>
                                    {% set usersRating = 0 %}
                                    {% for rating in series.ratings %}
                                        {% set usersRating = usersRating + rating.value %}
                                    {% endfor %}
                                    {% if series.ratings|length > 0 %}
                                        {% set usersRating = usersRating / series.ratings|length %}
                                    {% endif %}
                                    <p class="text-white mb-2">seen episodes:</p>
                                    {% if user %}
                                        <div class="relative pt-1">
                                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200">
                                                <div style="width:{{ (nb_episodes > 0 ? (nb_episodes_seen/nb_episodes)*100 : 0) }}%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-green-500"></div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    <p class="text-white mb-2">Users rating: {{ usersRating|number_format(1, '.', '') }}/5 </p>
                                    <p class="text-white mb-2">Number of votes: {{ series.ratings|length }}</p>
                            </div>
                            {% for genre in series.genres %}
                                        <span class="inline-block bg-gray-800 rounded-full px-3 py-1 text-sm font-semibold text-gray-300 mr-2 mb-2">{{ genre.name }}</span>
                            {% endfor %}
                        </a>
                        {% if user %}
                                {% if series in user.series %}
                                    <div class = "flex justify-center pb-4 pt-2 bg-red-600 rounded-b-lg font-bold">
                                    <form action="{{ path('app_series_unfollow', {'id': series.id,'page': pagination.getCurrentPageNumber()}) }}" method="post" class = "w-full h-full">
                                        <button type="submit" class="text-white hover:text-gray-300 w-full h-full">Unfollow</button>
                                    </form>
                                    </div>
                                {% else %}
                                    <div class = "flex justify-center pb-4 pt-2 bg-green-600 rounded-b-lg font-bold">
                                    <form action="{{ path('app_series_follow', {'id': series.id,'page': pagination.getCurrentPageNumber()}) }}" method="post" class = "w-full h-full">
                                        <button type="submit" class="text-white hover:text-gray-300 w-full h-full">Follow</button>
                                    </form>
                                    </div>
                                {% endif %}
                            {% endif %}
                    </div>
                {% else %}
                    <h1 class="text-4xl text-white font-bold mb-8">No series found</h1>
                {% endfor %}
            </div>
            <div class="flex justify-center mt-8">
            {% set total_pages = (pagination.getTotalItemCount() / pagination.getItemNumberPerPage())|round(0, 'ceil') %}
            {% set current_page = pagination.getCurrentPageNumber() %}

            {% if current_page != 1 %}
                <a href="{{ path(app_action, {'page': current_page - 1}) }}" class="text-white hover:text-gray-300 px-5">&laquo;</a>
            {% endif %}

            {% for page in 1..total_pages %}
                {% if page == current_page %}
                    <span class="text-white bg-red-500 rounded-full font-bold px-5">{{ page }}</span>
                {% elseif page == current_page - 1 or page == current_page + 1 %}
                    <a href="{{ path(app_action, {'page': page}) }}" class="text-white hover:text-gray-300 px-5">{{ page }}</a>
                {% elseif page == 1 or page == total_pages %}
                    <a href="{{ path(app_action, {'page': page}) }}" class="text-white hover:text-gray-300 px-5">{{ page }}</a>
                {% elseif page == current_page - 2 or page == current_page + 2 %}
                    <span class="text-white px-5">...</span>
                {% endif %}
            {% endfor %}

            {% if current_page != total_pages %}
                <a href="{{ path(app_action, {'page': current_page + 1}) }}" class="text-white hover:text-gray-300 px-5">&raquo;</a>
            {% endif %}
            </div>

            </div>
        </div>
    </div>
{% endblock %}
